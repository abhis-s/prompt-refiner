<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prompt Refinement App</title>
    <link rel="stylesheet" href="css/style.css" />
    <style>
      /* Highlight.js Line Numbers Plugin Styles */
      pre code.hljs {
        padding-left: 3.5em;
        position: relative;
      }

      .hljs-ln-numbers {
        text-align: right;
        color: #999;
        border-right: 1px solid #ccc;
        vertical-align: top;
        padding-right: 10px !important;
        user-select: none;
      }

      .hljs-ln-code {
        padding-left: 15px !important;
      }

      td.hljs-ln-numbers,
      td.hljs-ln-code {
        padding-top: 0 !important;
        padding-bottom: 0 !important;
      }
      /* Light mode slider */
      .slider {
        background-color: #333;
      }

      /* Dark mode slider */
      body.dark-mode .slider {
        background-color: #eee;
      }

      body.dark-mode input:checked + .slider {
        background-color: #81c784;
      }

      .header-container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: nowrap;
      }

      .toggle-container {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        justify-content: center;
        height: 100%;
      }

      .copy-button {
        float: right;
        margin-top: -26px;
        margin-bottom: 10px;
        background-color: #ddd;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
      }

      .copy-button:hover {
        background-color: #ccc;
      }

      body.dark-mode .copy-button {
        background-color: #444;
        color: #fff;
      }

      body.dark-mode .copy-button:hover {
        background-color: #666;
      }

      #modelSelect {
        margin-bottom: 10px;
      }

      /* Placeholder-like behavior for #refinedOutput */
      #refinedOutput:empty::before {
        content: "Refined prompt will appear here...";
        color: #999;
        font-style: italic;
      }
      body.dark-mode #refinedOutput:empty::before {
        color: #777;
      }
    </style>
    <!-- Highlight.js for syntax highlighting and line numbers -->
    <link
      id="hljs-light"
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css"
    />
    <link
      id="hljs-dark"
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css"
      disabled
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  </head>
  <body>
    <nav
      class="nav-bar"
      style="
        width: auto;
        margin-left: -40px;
        margin-right: -40px;
        padding-left: 20px;
        padding-right: 20px;
      "
    >
      <div class="header-container">
        <div
          class="header-title-row"
          style="display: flex; align-items: center"
        >
          <h1>Prompt Refinement App</h1>
          <div
            id="mode-toggle-pill-header"
            class="mode-toggle-pill"
            style="margin-left: 24px"
          >
            <input type="radio" id="vagueMode" name="mode" value="vague" />
            <label for="vagueMode" style="width: 70px">Vague</label>
            <input
              type="radio"
              id="structuredMode"
              name="mode"
              value="structured"
              checked
            />
            <label for="structuredMode" style="width: 100px">Structured</label>
            <span class="pill-slider"></span>
          </div>
          <button id="loadCacheBtn" class="modern-button">
            <strong>Load Cache</strong>
          </button>
          <div id="delete-cache-wrapper" style="display: none">
            <button
              id="delete-cache-button"
              class="nav-button red-button"
              disabled
              title="Delete cached data"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                height="20px"
                viewBox="0 -960 960 960"
                width="20px"
                fill="#e3e3e3"
              >
                <path
                  d="M312-144q-29.7 0-50.85-21.15Q240-186.3 240-216v-480h-48v-72h192v-48h192v48h192v72h-48v479.57Q720-186 698.85-165T648-144H312Zm336-552H312v480h336v-480ZM384-288h72v-336h-72v336Zm120 0h72v-336h-72v336ZM312-696v480-480Z"
                />
              </svg>
            </button>
          </div>
          <script>
            document.addEventListener("DOMContentLoaded", () => {
              function updateCacheButtons() {
                const loadBtn = document.getElementById("loadCacheBtn");
                const deleteWrapper = document.getElementById(
                  "delete-cache-wrapper"
                );
                const deleteBtn = document.getElementById(
                  "delete-cache-button"
                );
                // Use promptCache for cache presence check
                const cachedData = localStorage.getItem("promptCache");

                if (!cachedData) {
                  loadBtn.disabled = true;
                  loadBtn.classList.add("disabled");
                  loadBtn.innerHTML = "<strong>No Cache</strong>";
                  deleteWrapper.style.display = "none";
                } else {
                  loadBtn.disabled = false;
                  loadBtn.classList.remove("disabled");
                  loadBtn.innerHTML = "<strong>Load Cache</strong>";
                  deleteWrapper.style.display = "inline-block";
                  deleteBtn.disabled = false;
                }
              }

              // Call on load
              updateCacheButtons();

              // Hook into delete cache button
              document
                .getElementById("delete-cache-button")
                .addEventListener("click", () => {
                  localStorage.removeItem("promptCache");
                  updateCacheButtons();
                });

              // Call this after saving to cache elsewhere in the code:
              window.updateCacheButtons = updateCacheButtons;
            });
          </script>
        </div>
        <div class="toggle-container">
          <div class="toggle-row">
            <label class="switch">
              <input type="checkbox" onclick="toggleDarkMode()" />
              <span class="slider">
                <span class="icon-left">‚òÄÔ∏è</span>
                <span class="icon-right">üåô</span>
              </span>
            </label>
          </div>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="left-column">
        <div class="label-inline-group" style="margin-top: 20px">
          <label for="sampleSelect">Choose a Sample:</label>
          <select id="sampleSelect" onchange="populateFields(this.value)">
            <option value="">-- Select a sample --</option>
            <option value="sort">Sort List</option>
            <option value="email">Validate Email</option>
            <option value="blank">Blank</option>
          </select>
          <button
            id="generateBtnTop"
            onclick="generatePrompt()"
            disabled
            style="
              margin-left: 8px;
              margin-top: 4px;
              background-color: #4caf50;
              color: white;
              border: none;
              padding: 0;
              border-radius: 6px;
              height: 44px;
              width: 80px;
            "
          >
            ‚û§
          </button>
        </div>
        <div style="height: 10px"></div>

        <div class="label-inline-group">
          <label for="modelSelect">Select Model:</label>
          <select id="modelSelect">
            <option value="gpt-4.1">
              GPT-4.1 (High Quality) | SWE-Bench 54.6%
            </option>
            <option value="gpt-4o">
              GPT-4o (Fast, Default) | SWE-Bench 33.2%
            </option>
            <option value="gpt-4.1-mini">
              GPT-4.1 Mini (Compact, Smart) | SWE-Bench Not Specified
            </option>
          </select>
        </div>

        <div class="label-inline-group">
          <label for="languageSelect">Language to use:</label>
          <select id="languageSelect">
            <option value="Python" data-highlight="language-python" selected>
              Python
            </option>
          </select>
        </div>

        <!-- Mode Toggle Switch (Pill) moved to header -->
        <div style="height: 20px"></div>

        <!-- Vague Prompt Container -->
        <div id="vaguePromptContainer">
          <label for="vaguePrompt">Vague Prompt:</label>
          <textarea
            id="vaguePrompt"
            rows="3"
            placeholder="e.g., sort a list"
          ></textarea>
          <br />
          <br />
        </div>
        <!-- Structured Prompt Fields -->
        <div class="structured-section">
          <div class="label-inline-group">
            <label for="functionNameInput">Function Name:</label>
            <textarea
              id="functionName"
              rows="1"
              placeholder="e.g., sort_list"
              class="input"
            ></textarea>
          </div>
          <br />
          <div class="label-inline-group">
            <label for="argumentsInput">Arguments:</label>
            <textarea
              id="arguments"
              rows="2"
              placeholder="e.g., input_list: List[int]"
              class="input"
            ></textarea>
          </div>
          <br />
          <div class="label-inline-group">
            <label for="returnTypeInput">Return Type:</label>
            <textarea
              id="returnType"
              rows="1"
              placeholder="e.g., List[int]"
              class="input"
            ></textarea>
          </div>
          <br />
          <div class="label-inline-group">
            <label for="constraintsInput">Constraints:</label>
            <textarea
              id="constraints"
              rows="2"
              placeholder="e.g., no built-in functions, O(n log n)"
              class="input"
            ></textarea>
          </div>
          <br />
          <div class="label-inline-group">
            <label for="edgeCasesInput">Edge Cases:</label>
            <textarea
              id="edgeCases"
              rows="2"
              placeholder="e.g., empty list, duplicates"
              class="input"
            ></textarea>
          </div>
          <br />
          <div class="label-inline-group">
            <label for="expectedBehaviorInput">Expected Behavior:</label>
            <textarea
              id="expectedBehavior"
              rows="2"
              placeholder="e.g., return a new sorted list"
              class="input"
            ></textarea>
          </div>
          <br />
          <div class="label-inline-group">
            <label for="examplesInput">Input/Output Examples:</label>
            <textarea
              id="examples"
              rows="2"
              placeholder="e.g., input: [3,1,2] ‚Üí output: [1,2,3]"
              class="input"
            ></textarea>
          </div>
          <br />
        </div>
        <button id="generateBtnBtm" onclick="generatePrompt()" disabled>
          Generate Refined Prompt
        </button>
      </div>
      <div class="right-column">
        <div id="output-container">
          <div id="refinedPromptContainer" style="margin-top: 25px">
            <div>
              <label style="cursor: pointer" onclick="toggleRefinedPrompt()"
                >Generated Refined Prompt ‚ñº</label
              >
              <button
                class="copy-button"
                onclick="copyToClipboard('refinedOutput')"
                disabled
              >
                Copy
              </button>
            </div>
            <div class="output" id="refinedOutput"></div>
          </div>
        </div>
        <div
          id="recommendationsContainer"
          style="display: none; margin-top: 20px"
        >
          <div
            style="
              display: flex;
              align-items: center;
              justify-content: space-between;
            "
          >
            <label style="cursor: pointer" onclick="toggleRecommendations()"
              >Recommendations, Suggestions, and Comments ‚ñº</label
            >
            <button
              class="copy-button"
              onclick="copyToClipboard('recommendationsBox')"
              disabled
            >
              Copy
            </button>
          </div>
          <div
            id="recommendationsBox"
            class="output"
            style="margin-bottom: 0px"
          ></div>
        </div>
        <div id="markdownContainer" style="display: none; margin-top: 20px">
          <div
            style="
              display: flex;
              align-items: center;
              justify-content: space-between;
            "
          >
            <label style="cursor: pointer" onclick="toggleMarkdown()"
              >Markdown Output ‚ñº</label
            >
            <div style="display: flex; gap: 8px; align-items: center">
              <button
                class="copy-button"
                onclick="enableMarkdownEdit()"
                title="Edit"
              >
                <svg
                  class="edit-icon"
                  xmlns="http://www.w3.org/2000/svg"
                  height="20px"
                  viewBox="0 -960 960 960"
                  width="20px"
                  fill="#e3e3e3"
                >
                  <path
                    d="M216-216h51l375-375-51-51-375 375v51Zm-72 72v-153l498-498q11-11 23.84-16 12.83-5 27-5 14.16 0 27.16 5t24 16l51 51q11 11 16 24t5 26.54q0 14.45-5.02 27.54T795-642L297-144H144Zm600-549-51-51 51 51Zm-127.95 76.95L591-642l51 51-25.95-25.05Z"
                  />
                </svg>
              </button>
              <button
                class="copy-button"
                onclick="copyToClipboard('markdownBox')"
                disabled
              >
                Copy
              </button>
            </div>
          </div>
          <div id="markdownBox" class="output" style="margin-bottom: 0px">
            <div class="markdown-preview">
              <div class="markdown-header">python</div>
              <pre
                class="markdown-code"
              ><code class="language-python"></code></pre>
            </div>
          </div>
        </div>
        <br />
        <br />
        <!-- Pyodide Run Code Button and Output -->
        <button
          id="runCodeBtn"
          onclick="executeGeneratedCode()"
          style="display: none"
        >
          Run Code
        </button>
        <pre id="executionResult" class="output" style="display: none"></pre>
      </div>
    </div>

    <script type="text/javascript">
      async function loadPyodideAndInitialize() {
        const pyodideScript = document.createElement("script");
        pyodideScript.src =
          "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js";
        pyodideScript.onload = async () => {
          if (typeof loadPyodide === "function") {
            pyodide = await loadPyodide();
            pyodideReady = true;
          } else {
            console.error("loadPyodide is not available.");
          }
        };
        document.body.appendChild(pyodideScript);
      }

      loadPyodideAndInitialize();
    </script>
    <!-- Main client-side logic as ES module -->
    <script src="js/client.js"></script>
  </body>
</html>
